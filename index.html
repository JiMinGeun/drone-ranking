<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë“œë¡  ë ˆì´ì‹±</title>
  <style>
    :root{
      --bg:#f6efff;
      --ink:#0f172a;
      --card:#ffffff;
      --muted:#6b7280;
      --primary:#7c3aed;
      --accent:#f59e0b;
      --danger:#ef4444;
      --line:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:'Pretendard','Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,sans-serif; color:var(--ink);
      background:linear-gradient(180deg,#f7f2ff, #f1eaff 60%, #efe7ff);
      font-size: clamp(14px, 2.6vw, 16px);
    }
    header{position:sticky; top:0; backdrop-filter:saturate(180%) blur(8px); background:#ffffffcc; border-bottom:1px solid #ffffff;}
    header .inner{max-width:980px; margin:0 auto; padding:14px 20px; display:flex; align-items:center; justify-content:space-between}
    .logo{display:flex; align-items:center; gap:8px; font-weight:900; letter-spacing:.8px;}
    .logo img{height:clamp(28px, 6vw, 50px); width:auto; border-radius:50%;}
    .title-center{font-weight:800; font-size:clamp(16px, 4.5vw, 20px); text-align:center; color:var(--ink);}

    .btn{border:0; cursor:pointer; display:inline-flex; align-items:center; gap:8px; padding:clamp(8px,1.8vw,10px) clamp(10px,3vw,14px); border-radius:12px; font-weight:700}
    .btn-primary{background:var(--primary); color:#fff}
    .btn-ghost{background:#fff; color:var(--ink); border:1px solid #e5e7eb}
    .btn-danger{background:var(--danger); color:#fff}

    .container{max-width:980px; margin:0 auto; padding:clamp(12px,4vw,20px)}
    .card{background:var(--card); border:1px solid #eee; border-radius:16px; padding:18px; box-shadow:0 10px 26px rgba(17,12,46,.08)}

    /* í‘œ(ë°ìŠ¤í¬í†±/íƒœë¸”ë¦¿) */
    .ranking{overflow:hidden}
    .table-wrap{width:100%; overflow-x:auto}
    table{width:100%; border-collapse:collapse}
    thead th{font-size:12px; letter-spacing:.6px; color:#6b7280; text-align:left; padding:12px 16px; border-bottom:1px solid var(--line)}
    tbody td{padding:14px 16px; border-bottom:1px solid var(--line)}
    tbody tr:nth-child(odd){background:#fafafa}
    .rank-badge{font-weight:800; display:flex; align-items:center; gap:8px}
    .medal{width:22px; height:22px; display:inline-grid; place-items:center; border-radius:999px; font-size:14px}
    .medal.gold{background:#fff7db; color:#b45309}
    .medal.silver{background:#eef2ff; color:#475569}
    .medal.bronze{background:#fff0d6; color:#b45309}
    .name{font-weight:700}
    .sub{font-size:12px; color:#6b7280; margin-top:4px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-weight:700; letter-spacing:.6px}

    /* Bì•ˆ: ëª¨ë°”ì¼ì—ì„œ ì¹´ë“œí˜• ë¦¬ìŠ¤íŠ¸ í‘œì‹œ */
    .list-cards{display:none}
    .list-card{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px; border:1px solid var(--line); border-radius:12px; background:#fff}
    .list-card .who{display:flex; align-items:flex-start; gap:10px}
    .list-card .names{display:flex; flex-direction:column}
    .list-card .klass{font-size:12px; color:var(--muted)}
    .list-card .time{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-weight:700}

    /* ê´€ë¦¬ì */
    .adminHeader{display:flex; align-items:center; justify-content:space-between; margin-bottom:12px}
    .actions{display:flex; gap:8px}
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center}
    .modal::before{content:''; position:absolute; inset:0; background:rgba(0,0,0,.45)}
    .modal .box{position:relative; z-index:1; width:100%; max-width:440px; background:#fff; border-radius:16px; padding:18px}
    .form-row{display:flex; gap:8px; margin-top:10px}
    input{flex:1; padding:12px 12px; border-radius:12px; border:1px solid #e5e7eb; font-size:14px}

    .hidden{display:none !important}

    /* ë°˜ì‘í˜• ì „í™˜ ì§€ì  */
    @media (max-width: 540px){
      .ranking table{display:none}
      .list-cards{display:flex; flex-direction:column; gap:10px}
    }
    @media (max-width: 360px){
      .logo span{display:none}
      .title-center{font-size:16px}
    }

    /* ì´ë¯¸ì§€ê°€ ì˜ì—­ì„ ë„˜ì§€ ì•Šë„ë¡ ê¸°ë³¸ ê°€ë“œ */
    img{max-width:100%; height:auto}
  </style>
</head>
<body>
  <header>
    <div class="inner">
      <div class="logo">
        <!-- ë°°ì§€/ë¡œê³  ì´ë¯¸ì§€: í”„ë¡œì íŠ¸ì— ì‹¤ì œë¡œ ì˜¬ë¦° íŒŒì¼ëª…ìœ¼ë¡œ ë³€ê²½í•˜ì„¸ìš” -->
        <img src="drone.png" alt="DOGO ë¡œê³ " style="width:80px; height:auto;">>
        <span>DOGO</span>
      </div>
      <div class="title-center">ë“œë¡  ë ˆì´ì‹±</div>
      <div>
        <button id="adminBtn" class="btn btn-ghost">Admin</button>
        <button id="logoutBtn" class="btn btn-ghost hidden">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- ê³µê°œ ë­í‚¹ ë·° -->
    <section id="viewPublic">
      <div class="card ranking">
        <h3 class="title-center" style="color:var(--primary); margin-top:0">ë­í‚¹</h3>
        <!-- ë°ìŠ¤í¬í†±/íƒœë¸”ë¦¿: í‘œ -->
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>RANK</th>
                <th>NAME</th>
                <th>CLASS</th>
                <th>TIME</th>
              </tr>
            </thead>
            <tbody id="tbodyPublic"></tbody>
          </table>
        </div>
        <!-- ëª¨ë°”ì¼: ì¹´ë“œ -->
        <div id="cardsPublic" class="list-cards" aria-hidden="true"></div>
      </div>
    </section>

    <!-- ê´€ë¦¬ì ë·° -->
    <section id="viewAdmin" class="hidden">
      <div class="adminHeader">
        <button id="backBtn" class="btn btn-primary">â† ë’¤ë¡œê°€ê¸°</button>
        <button id="addBtn" class="btn btn-primary">ï¼‹ ì¶”ê°€í•˜ê¸°</button>
      </div>
      <div class="card">
        <h3 style="margin:6px 0 14px">ê¸°ë¡ ê´€ë¦¬</h3>
        <div class="table-wrap">
          <table class="table-admin">
            <thead>
              <tr>
                <th>Name</th>
                <th>Class</th>
                <th>Time</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="tbodyAdmin"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- ë¹„ë°€ë²ˆí˜¸ ëª¨ë‹¬ -->
  <div id="pwModal" class="modal" aria-hidden="true">
    <div class="box">
      <h3 style="margin:0 0 10px">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</h3>
      <input id="pwInput" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" />
      <div class="form-row">
        <button id="pwCancel" class="btn btn-ghost">ì·¨ì†Œ</button>
        <button id="pwOk" class="btn btn-primary">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="formModal" class="modal" aria-hidden="true">
    <div class="box">
      <h3 id="formTitle" style="margin:0 0 10px">ê¸°ë¡ ì¶”ê°€</h3>
      <div class="form-row">
        <input id="nameInput" placeholder="ì´ë¦„" />
        <input id="classInput" placeholder="í•™ê¸‰ (ì˜ˆ: ê³ 1-3)" />
      </div>
      <div class="form-row">
        <input id="timeInput" placeholder="ê¸°ë¡ (ì˜ˆ: 05:07.008 ë˜ëŠ” 307.008)" />
      </div>
      <div class="form-row" style="justify-content:flex-end">
        <button id="formCancel" class="btn btn-ghost">ì·¨ì†Œ</button>
        <button id="formSave" class="btn btn-primary">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>

  <script>
    // ===== Firebase ì„¤ì • =====
    const firebaseConfig = {
      apiKey: "AIzaSyDQdYziYofadFexbv9CjgaSDoV701kJq7eo",
      authDomain: "studio-1121796292-145f8.firebaseapp.com",
      databaseURL: "https://studio-1121796292-145f8-default-rtdb.firebaseio.com",
      projectId: "studio-1121796292-145f8",
      storageBucket: "studio-1121796292-145f8.appspot.com",
      messagingSenderId: "505956643695",
      appId: "1:505956643695:web:6766fd9a4cb3b87d35409a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== ê°„ì´ ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ =====
    const ADMIN_PASSWORD = "dogae123!";

    // ===== ìƒíƒœ / DOM =====
    let isAdmin = JSON.parse(sessionStorage.getItem('isAdmin') || 'false');
    let editingKey = null; // í¸ì§‘ ì¤‘ í‚¤ (ì´ë¦„ ê¸°ë°˜)

    const viewPublic = document.getElementById('viewPublic');
    const viewAdmin  = document.getElementById('viewAdmin');
    const tbodyPublic = document.getElementById('tbodyPublic');
    const tbodyAdmin  = document.getElementById('tbodyAdmin');

    const cardsPublic = document.getElementById('cardsPublic');

    const adminBtn = document.getElementById('adminBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const backBtn = document.getElementById('backBtn');
    const addBtn = document.getElementById('addBtn');

    const pwModal = document.getElementById('pwModal');
    const pwInput = document.getElementById('pwInput');
    const pwOk = document.getElementById('pwOk');
    const pwCancel = document.getElementById('pwCancel');

    const formModal = document.getElementById('formModal');
    const formTitle = document.getElementById('formTitle');
    const nameInput = document.getElementById('nameInput');
    const classInput = document.getElementById('classInput');
    const timeInput = document.getElementById('timeInput');
    const formSave = document.getElementById('formSave');
    const formCancel = document.getElementById('formCancel');

    // ===== ìœ í‹¸ =====
    const esc = s => String(s).replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));

    function parseTimeToMs(v){
      // ì…ë ¥: "mm:ss.mmm" ë˜ëŠ” ì´ì´ˆ(ì´ˆ.ë°€ë¦¬)
      const s = String(v).trim();
      if(!s) return NaN;
      if(s.includes(':')){
        const [mm, rest] = s.split(':');
        const [ss, ms='0'] = rest.split('.');
        const minutes = parseInt(mm,10)||0;
        const seconds = parseInt(ss,10)||0;
        const millis  = parseInt(String(ms).padEnd(3,'0').slice(0,3),10)||0;
        return (minutes*60 + seconds)*1000 + millis;
      }
      const num = Number(s);
      if(isNaN(num)) return NaN;
      return Math.round(num*1000);
    }
    function formatMs(ms){
      if(ms==null || isNaN(ms)) return '-';
      const total = Math.max(0, Math.round(ms));
      const minutes = Math.floor(total/60000);
      const seconds = Math.floor((total%60000)/1000);
      const millis  = total%1000;
      const mm = String(minutes).padStart(2,'0');
      const ss = String(seconds).padStart(2,'0');
      const mmm= String(millis).padStart(3,'0');
      return `${mm}:${ss}.${mmm}`;
    }
    function toggleView(){
      viewPublic.classList.toggle('hidden', isAdmin);
      viewAdmin.classList.toggle('hidden', !isAdmin);
      adminBtn.classList.toggle('hidden', isAdmin);
      logoutBtn.classList.toggle('hidden', !isAdmin);
      sessionStorage.setItem('isAdmin', JSON.stringify(isAdmin));
    }
    function open(el){ el.style.display='flex'; }
    function close(el){ el.style.display='none'; }

    // ===== ëª¨ë‹¬/ë²„íŠ¼ ë™ì‘ =====
    adminBtn.onclick = ()=>{ if(!isAdmin){ open(pwModal); pwInput.value=''; pwInput.focus(); } };
    pwOk.onclick = ()=>{
      if(pwInput.value === ADMIN_PASSWORD){ isAdmin = true; toggleView(); close(pwModal); }
      else alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
    }
    pwCancel.onclick = ()=> close(pwModal);
    logoutBtn.onclick = ()=>{ isAdmin=false; toggleView(); };
    backBtn.onclick = ()=>{ isAdmin=false; toggleView(); };

    addBtn && (addBtn.onclick = ()=>{
      editingKey = null;
      formTitle.textContent = 'ê¸°ë¡ ì¶”ê°€';
      nameInput.value=''; classInput.value=''; timeInput.value='';
      open(formModal); nameInput.focus();
    });
    formCancel.onclick = ()=> close(formModal);

    formSave.onclick = async ()=>{
      const name = nameInput.value.trim();
      const klass = classInput.value.trim();
      const ms = parseTimeToMs(timeInput.value);
      if(!name || isNaN(ms)) return alert('ì´ë¦„ê³¼ ì‹œê°„ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”. ì˜ˆ) 05:07.008');
      const key = editingKey || name; // ê°„ë‹¨ ë²„ì „: ì´ë¦„ì„ í‚¤ë¡œ ì‚¬ìš©
      await db.ref('participants/'+key).set({name, klass, timeMs: ms, time: (ms/1000)});
      close(formModal);
    };

    function onEdit(p){
      editingKey = p.name;
      formTitle.textContent = 'ê¸°ë¡ ìˆ˜ì •';
      nameInput.value = p.name || '';
      classInput.value = p.klass || '';
      timeInput.value = formatMs(p.timeMs ?? (Number(p.time)||0)*1000);
      open(formModal);
    }
    async function onDelete(p){
      if(confirm(`ì •ë§ "${p.name}" ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?`)){
        await db.ref('participants/'+p.name).remove();
      }
    }

    // ===== ë Œë”ë§ =====
    let list = [];
    function renderPublic(){
      // í‘œ ë Œë”
      if(list.length===0){
        tbodyPublic.innerHTML = `<tr><td colspan="4" class="sub">ì•„ì§ ì°¸ê°€ìê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
      } else {
        tbodyPublic.innerHTML = list.map((p,i)=>{
          const medal = i===0? 'gold' : i===1? 'silver' : i===2? 'bronze' : '';
          const badge = medal ? `<span class="medal ${medal}">ğŸ…</span>` : `<strong>${i+1}</strong>`;
          return `<tr>
            <td class="rank-badge">${badge}</td>
            <td><div class="name">${esc(p.name)}</div></td>
            <td>${esc(p.klass||'')}</td>
            <td class="mono">${formatMs(p.timeMs ?? (Number(p.time)||0)*1000)}</td>
          </tr>`;
        }).join('');
      }

      // ëª¨ë°”ì¼ ì¹´ë“œ ë Œë”
      if(cardsPublic){
        cardsPublic.innerHTML = list.map((p,i)=>{
          const medal = i===0? 'gold' : i===1? 'silver' : i===2? 'bronze' : '';
          const badge = medal ? `<span class="medal ${medal}">ğŸ…</span>` : `<strong>${i+1}</strong>`;
          const timeTxt = formatMs(p.timeMs ?? (Number(p.time)||0)*1000);
          return `<div class="list-card">
            <div class="who">
              <div class="rank-badge">${badge}</div>
              <div class="names">
                <div class="name">${esc(p.name)}</div>
                <div class="klass">${esc(p.klass||'')}</div>
              </div>
            </div>
            <div class="time">${timeTxt}</div>
          </div>`;
        }).join('');
      }
    }

    function renderAdmin(){
      tbodyAdmin.innerHTML = list.map(p=>{
        return `<tr>
          <td>${esc(p.name)}</td>
          <td>${esc(p.klass||'')}</td>
          <td class="mono">${formatMs(p.timeMs ?? (Number(p.time)||0)*1000)}</td>
          <td>
            <div class="actions">
              <button class="btn btn-ghost" onclick='editRow("${esc(p.name)}")'>âœ</button>
              <button class="btn btn-danger" onclick='deleteRow("${esc(p.name)}")'>ğŸ—‘</button>
            </div>
          </td>
        </tr>`;
      }).join('');
    }

    // ì „ì—­ í•¸ë“¤ëŸ¬(í…Œì´ë¸” ë‚´ onClickì—ì„œ ì‚¬ìš©)
    window.editRow = (name)=>{ const p = list.find(x=>x.name===name); if(p) onEdit(p); }
    window.deleteRow = async (name)=>{ const p = list.find(x=>x.name===name); if(p) await onDelete(p); }

    // ===== ì‹¤ì‹œê°„ êµ¬ë… =====
    db.ref('participants').on('value', snap => {
      const data = snap.val() || {};
      list = Object.values(data).sort((a,b)=>{
        const ams = (a.timeMs ?? (Number(a.time)||0)*1000);
        const bms = (b.timeMs ?? (Number(b.time)||0)*1000);
        return ams - bms;
      });
      renderPublic();
      renderAdmin();
    });

    // ì´ˆê¸° í‘œì‹œ
    toggleView();
  </script>
</body>
</html>


