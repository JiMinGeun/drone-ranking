<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>드론 경주 실시간 순위</title>
  <style>
    :root { --bg1:#00bcd4; --bg2:#007bff; --glass:rgba(255,255,255,.12); --ink:#0f172a; }
    *{box-sizing:border-box}
    body{font-family:'Noto Sans KR',system-ui,Segoe UI,Roboto,sans-serif;background:linear-gradient(135deg,var(--bg1),var(--bg2));color:#fff;margin:0;min-height:100vh;display:flex;flex-direction:column;align-items:center;gap:14px;padding:16px}
    h1{margin:6px 0 0;text-align:center;font-size:clamp(20px,4vw,28px)}
    .wrap{width:100%;max-width:880px;display:flex;flex-direction:column;gap:12px}
    .bar,.card{background:rgba(0,0,0,.22);backdrop-filter:blur(6px);border-radius:14px;padding:14px;box-shadow:0 8px 26px rgba(0,0,0,.18)}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .sp{justify-content:space-between}
    table{width:100%;border-collapse:collapse;background:var(--glass);border-radius:12px;overflow:hidden}
    th,td{padding:11px 10px;text-align:center;border-bottom:1px solid rgba(255,255,255,.28)}
    th{background:rgba(255,255,255,.18);font-weight:700}
    tr:last-child td{border-bottom:none}
    input{padding:10px 12px;border-radius:10px;border:none;outline:none;background:#fff;color:var(--ink)}
    button{border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .btn{background:#ffeb3b;color:#111}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.5);color:#fff}
    .tag{display:inline-flex;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.2);font-size:12px}
    /* 관리자 UI는 기본 숨김 */
    .admin-only{display:none}
    /* 비번 모달 */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px}
    .modal .box{width:100%;max-width:380px;background:#fff;color:#111;border-radius:14px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .modal h3{margin:0 0 8px}
    .modal .row{justify-content:flex-end}
    .danger{background:#ef4444;color:#fff}
    .muted{opacity:.85}
  </style>
</head>
<body>
  <h1>🏁 드론 경주 실시간 순위</h1>
  <div class="wrap">
    <!-- 상단 바 -->
    <div class="bar row sp">
      <div class="row"><span>상태:</span><span id="state" class="tag">관람 모드</span></div>
      <div class="row">
        <button id="adminBtn" class="btn-ghost">🔐 관리자</button>
        <button id="logoutBtn" class="btn-ghost admin-only">로그아웃</button>
      </div>
    </div>

    <!-- 순위표 -->
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>순위</th><th>이름</th><th>기록(초)</th><th id="thActions" class="admin-only">관리</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <!-- 관리자 입력 카드 -->
    <div id="adminPanel" class="card admin-only">
      <h3 style="margin:6px 0 10px">기록 추가 / 수정</h3>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <input id="nameInput" placeholder="이름" />
        <input id="timeInput" type="number" step="0.01" placeholder="기록(초)" />
        <button id="saveBtn" class="btn">등록/업데이트</button>
        <button id="resetBtn" class="btn-ghost danger">전체 초기화</button>
      </div>
      <p class="muted" style="margin:8px 0 0">※ 같은 이름을 다시 저장하면 기록이 업데이트됩니다.</p>
    </div>
  </div>

  <!-- 비밀번호 모달 -->
  <div id="pwModal" class="modal" aria-hidden="true">
    <div class="box">
      <h3>관리자 비밀번호</h3>
      <input id="pwInput" type="password" placeholder="비밀번호 입력" style="width:100%" />
      <div class="row" style="margin-top:10px">
        <button id="pwCancel" class="btn-ghost">취소</button>
        <button id="pwOk" class="btn">확인</button>
      </div>
      <p class="muted" style="margin-top:6px">행사용 간단 보호입니다. 강한 보안이 필요하면 Firebase Authentication을 사용하세요.</p>
    </div>
  </div>

  <!-- Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>

  <script>
    // Firebase 설정 (당신 프로젝트)
    const firebaseConfig = {
      apiKey: "AIzaSyDQdYziYofadFexbv9CjgaSDoV701kJq7eo",
      authDomain: "studio-1121796292-145f8.firebaseapp.com",
      databaseURL: "https://studio-1121796292-145f8-default-rtdb.firebaseio.com",
      projectId: "studio-1121796292-145f8",
      storageBucket: "studio-1121796292-145f8.appspot.com",
      messagingSenderId: "505956643695",
      appId: "1:505956643695:web:6766fd9a4cb3b87d35409a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 간이 관리자 비밀번호 (필요시 변경)
    const ADMIN_PASSWORD = "droneadmin";

    // 상태
    let isAdmin = false;

    // DOM
    const state = document.getElementById('state');
    const adminBtn = document.getElementById('adminBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminPanel = document.getElementById('adminPanel');
    const thActions = document.getElementById('thActions');
    const tbody = document.getElementById('tbody');

    const nameInput = document.getElementById('nameInput');
    const timeInput = document.getElementById('timeInput');
    const saveBtn = document.getElementById('saveBtn');
    const resetBtn = document.getElementById('resetBtn');

    const pwModal = document.getElementById('pwModal');
    const pwInput = document.getElementById('pwInput');
    const pwOk = document.getElementById('pwOk');
    const pwCancel = document.getElementById('pwCancel');

    // 공통: 관리자 UI 토글
    function applyAdminUI(){
      document.querySelectorAll('.admin-only').forEach(el=>{ el.style.display = isAdmin ? '' : 'none'; });
      adminPanel.style.display = isAdmin ? '' : 'none';
      thActions.style.display = isAdmin ? '' : 'none';
      state.textContent = isAdmin ? '관리자 모드' : '관람 모드';
      adminBtn.textContent = isAdmin ? '🔐 관리자(ON)' : '🔐 관리자';
      logoutBtn.style.display = isAdmin ? '' : 'none';
      render();
    }

    // 모달 열고닫기
    function openModal(){ pwModal.style.display='flex'; pwInput.value=''; pwInput.focus(); }
    function closeModal(){ pwModal.style.display='none'; }

    adminBtn.onclick = ()=>{ if(!isAdmin) openModal(); };
    pwCancel.onclick = closeModal;
    pwOk.onclick = ()=>{
      if(pwInput.value === ADMIN_PASSWORD){
        isAdmin = true; closeModal(); applyAdminUI(); alert('관리자 모드로 전환되었습니다.');
      } else { alert('비밀번호가 올바르지 않습니다.'); }
    };
    logoutBtn.onclick = ()=>{ isAdmin = false; applyAdminUI(); };

    // 데이터 조작
    async function saveRecord(){
      if(!isAdmin) return alert('관리자만 사용할 수 있습니다.');
      const name=(nameInput.value||'').trim();
      const time=parseFloat(timeInput.value);
      if(!name || isNaN(time)) return alert('이름과 기록(초)을 모두 입력하세요.');
      await db.ref('participants/'+name).set({name,time});
      nameInput.value=''; timeInput.value='';
    }
    async function removeAll(){
      if(!isAdmin) return alert('관리자만 사용할 수 있습니다.');
      if(confirm('정말 전체 데이터를 초기화할까요?')) await db.ref('participants').remove();
    }
    function editRecord(name,time){
      if(!isAdmin) return alert('관리자만 사용할 수 있습니다.');
      nameInput.value=name; timeInput.value=time; window.scrollTo({top:document.body.scrollHeight,behavior:'smooth'});
    }
    async function deleteRecord(name){
      if(!isAdmin) return alert('관리자만 사용할 수 있습니다.');
      if(confirm(`정말 "${name}" 기록을 삭제할까요?`)) await db.ref('participants/'+name).remove();
    }

    saveBtn.onclick = saveRecord;
    resetBtn.onclick = removeAll;

    // 렌더링
    let cached = [];
    function render(){
      const list = [...cached].sort((a,b)=>Number(a.time)-Number(b.time));
      tbody.innerHTML = list.map((p,i)=>{
        const actions = isAdmin ? `
          <td class="admin-only">
            <div class="row" style="justify-content:center">
              <button class="btn-ghost" onclick="editRecord('${p.name.replace(/'/g,"&#39;")}', ${Number(p.time)})">수정</button>
              <button class="btn-ghost danger" onclick="deleteRecord('${p.name.replace(/'/g,"&#39;")}')">삭제</button>
            </div>
          </td>` : '<td class="admin-only"></td>';
        return `<tr>
          <td>${i+1}</td>
          <td>${p.name}</td>
          <td>${Number(p.time).toFixed(2)}</td>
          ${actions}
        </tr>`;
      }).join('');
    }

    // 실시간 구독
    db.ref('participants').on('value', snap => {
      const data = snap.val() || {}; cached = Object.values(data); render();
    });

    // 초기 UI
    applyAdminUI();

    // 전역에서 쓰는 핸들러 노출 (테이블 onclick용)
    window.editRecord = editRecord;
    window.deleteRecord = deleteRecord;
  </script>
</body>
</html>
