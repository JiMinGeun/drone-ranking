<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>드론 경주 실시간 순위</title>
  <style>
    :root { --card: rgba(0,0,0,.22); --glass: rgba(255,255,255,.12); }
    *{box-sizing:border-box}
    body { font-family: 'Noto Sans KR', sans-serif; background: linear-gradient(135deg,#0ea5e9,#06b6d4); color:#fff; margin:0; min-height:100vh; display:flex; flex-direction:column; align-items:center; gap:14px; padding:16px; }
    h1 { margin: 10px 0 0; text-align:center; font-size: clamp(20px, 4vw, 28px); }
    .wrap { width:100%; max-width: 760px; display:flex; flex-direction:column; gap:12px; }
    .card { background:var(--card); backdrop-filter: blur(6px); border-radius:14px; padding:14px; box-shadow: 0 6px 20px rgba(0,0,0,.15); }
    table { width:100%; border-collapse: collapse; background: var(--glass); border-radius: 12px; overflow:hidden; }
    th,td { padding:10px; text-align:center; border-bottom:1px solid rgba(255,255,255,.28); }
    th { background: rgba(255,255,255,.18); font-weight:700; }
    tr:last-child td { border-bottom:none; }
    .row { display:flex; flex-wrap:wrap; gap:8px; align-items:center; }
    input, select { flex:1 1 160px; min-width:140px; padding:10px 12px; border-radius:10px; border:none; outline:none; background:#fff; color:#111; }
    button { border:none; border-radius:10px; padding:10px 14px; font-weight:700; cursor:pointer; }
    .btn-primary { background:#ffeb3b; color:#111; }
    .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,.5); color:#fff; }
    .admin-only { display:none; }
    .tag { display:inline-flex; padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.2); font-size:12px; }
  </style>
</head>
<body>
  <h1>🏁 드론 경주 실시간 순위</h1>
  <div class="wrap">

    <!-- 상단 바: 관리자 버튼 / 상태 -->
    <div class="card row" style="justify-content:space-between;">
      <div class="row" style="gap:6px">
        <span>상태:</span>
        <span id="statusTag" class="tag">관람 모드</span>
      </div>
      <div class="row" style="gap:8px">
        <button id="adminBtn" class="btn-ghost">🔐 관리자</button>
        <button id="logoutBtn" class="btn-ghost admin-only">로그아웃</button>
      </div>
    </div>

    <!-- 순위표 -->
    <div class="card">
      <table>
        <thead><tr><th>순위</th><th>이름</th><th>기록(초)</th><th id="thActions" class="admin-only">관리</th></tr></thead>
        <tbody id="rankingBody"></tbody>
      </table>
    </div>

    <!-- 관리자 입력 카드 -->
    <div id="adminSection" class="card admin-only">
      <h3 style="margin:6px 0 10px">기록 추가/수정</h3>
      <div class="row">
        <input id="nameInput" type="text" placeholder="이름" />
        <input id="timeInput" type="number" step="0.01" placeholder="기록(초)" />
        <button id="addBtn" class="btn-primary">등록 / 업데이트</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="resetBtn" class="btn-ghost">전체 초기화</button>
      </div>
    </div>

  </div>

  <!-- ✅ Firebase compat SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-database-compat.js"></script>

  <script>
    // 1) Firebase 설정 (이미 발급된 값)
    const firebaseConfig = {
      apiKey: "AIzaSyDQdYziYofadFexbv9CjgaSDoV701kJq7eo",
      authDomain: "studio-1121796292-145f8.firebaseapp.com",
      databaseURL: "https://studio-1121796292-145f8-default-rtdb.firebaseio.com",
      projectId: "studio-1121796292-145f8",
      storageBucket: "studio-1121796292-145f8.appspot.com",
      messagingSenderId: "505956643695",
      appId: "1:505956643695:web:6766fd9a4cb3b87d35409a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // 2) 간이 관리자 비밀번호 (클라이언트 보호 수준, 소스보면 보임)
    // 행사용 간편 보호. 진짜 보안이 필요하면 Firebase Authentication을 권장합니다.
    const ADMIN_PASSWORD = "dogae123!"; // ← 원하는 값으로 변경

    let isAdmin = false;

    // UI 요소
    const tbody = document.getElementById('rankingBody');
    const thActions = document.getElementById('thActions');
    const adminSection = document.getElementById('adminSection');
    const adminBtn = document.getElementById('adminBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const statusTag = document.getElementById('statusTag');
    const nameInput = document.getElementById('nameInput');
    const timeInput = document.getElementById('timeInput');
    const addBtn = document.getElementById('addBtn');
    const resetBtn = document.getElementById('resetBtn');

    // 관리자 토글
    function applyAdminUI() {
      document.querySelectorAll('.admin-only').forEach(el => {
        el.style.display = isAdmin ? '' : 'none';
      });
      statusTag.textContent = isAdmin ? '관리자 모드' : '관람 모드';
      adminBtn.textContent = isAdmin ? '🔐 관리자(ON)' : '🔐 관리자';
    }

    adminBtn.onclick = () => {
      if (isAdmin) return; // 이미 관리자면 무시
      const pw = prompt('관리자 비밀번호를 입력하세요.');
      if (pw === null) return;
      if (pw === ADMIN_PASSWORD) {
        isAdmin = true;
        applyAdminUI();
        alert('관리자 모드로 전환되었습니다.');
      } else {
        alert('비밀번호가 올바르지 않습니다.');
      }
    };

    logoutBtn.onclick = () => {
      isAdmin = false;
      applyAdminUI();
    };

    // 기록 추가/수정
    addBtn.onclick = async () => {
      if (!isAdmin) return alert('관리자만 사용할 수 있습니다.');
      const name = (nameInput.value||'').trim();
      const time = parseFloat(timeInput.value);
      if (!name || isNaN(time)) return alert('이름과 기록(초)을 모두 입력하세요.');
      await db.ref('participants/' + name).set({ name, time });
      nameInput.value = ''; timeInput.value = '';
    };

    // 전체 초기화 (주의)
    resetBtn.onclick = async () => {
      if (!isAdmin) return alert('관리자만 사용할 수 있습니다.');
      const ok = confirm('정말 전체 데이터를 초기화할까요? (되돌릴 수 없음)');
      if (!ok) return;
      await db.ref('participants').remove();
    };

    // 편집/삭제 핸들러
    function editRecord(name, time){
      if (!isAdmin) return alert('관리자만 사용할 수 있습니다.');
      nameInput.value = name;
      timeInput.value = time;
      window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'});
    }
    async function deleteRecord(name){
      if (!isAdmin) return alert('관리자만 사용할 수 있습니다.');
      const ok = confirm(`정말 \"${name}\" 기록을 삭제할까요?`);
      if (!ok) return;
      await db.ref('participants/' + name).remove();
    }

    // 실시간 조회 & 렌더링
    db.ref('participants').on('value', (snap) => {
      const data = snap.val() || {};
      const list = Object.values(data).sort((a,b) => Number(a.time) - Number(b.time));
      tbody.innerHTML = list.map((p,i)=>{
        const actionBtns = `<div class="row" style="justify-content:center">
            <button class="btn-ghost" onclick="editRecord('${p.name.replace(/'/g, "&#39;")}', '${Number(p.time)}')">수정</button>
            <button class="btn-ghost" onclick="deleteRecord('${p.name.replace(/'/g, "&#39;")}')">삭제</button>
          </div>`;
        return `<tr>
          <td>${i+1}</td>
          <td>${p.name}</td>
          <td>${Number(p.time).toFixed(2)}</td>
          <td class="admin-only">${actionBtns}</td>
        </tr>`;
      }).join('');
      // 헤더 액션 컬럼 표시 상태 동기화
      thActions.style.display = isAdmin ? '' : 'none';
      // 행의 admin-only 버튼 표시 갱신
      document.querySelectorAll('.admin-only').forEach(el => {
        if (el.tagName === 'TD' || el.id === 'thActions') el.style.display = isAdmin ? '' : 'none';
      });
    });

    // 초기 UI 상태 설정
    applyAdminUI();
  </script>
</body>
</html>
